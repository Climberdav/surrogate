function compressbackup() {

echo "========================================="
echo "           MySQL Compress                " 
echo "========================================="


full_backup=`head $compress -n 1`

echo $full_backup

if [ -d $active_backup ];
then
 rm -R $active_backup
fi

echo "copying full backup files: " $full_backup
mkdir $active_backup
cp -r $full_backup/* $active_backup

echo "preparing full backup..."
innobackupex --ibbackup=xtrabackup_55 --parallel=4 --user=$mysql_user --password=$mysql_pass --apply-log --redo-only $active_backup 2> $logfile_c

# see if the apply-log completed sucsessfully
if ! tail $logfile_c -n 1 | grep completed.OK
then
        echo "\nERROR: restore failed!"
	rm -R $active_backup
        exit 1
fi


grep _in $compress | while read incremental_backup ; do

 if [ -d $active_incremental ];
 then
  rm -R $active_incremental
 fi

 echo "copying incremental backup: " $incremental_backup
 mkdir $active_incremental
 cp -r $incremental_backup/* $active_incremental

 find $incremental_backup -name .delta -empty -maxdepth 2 -exec rm {} \;

        echo "preparing incremetal backup..."
 innobackupex --ibbackup=xtrabackup_55 --parallel=4 --user=$mysql_user --password=$mysql_pass --apply-log --redo-only $active_backup --incremental-dir=$active_incremental 2>> $logfile_c

 rm -R $active_incremental

 # see if the apply incremental completed sucsessfully
 if ! tail $logfile_c -n 1 | grep completed.OK
 then
         echo "\nERROR: collapse failed!"
         rm -R $active_backup
         exit 1
 fi

done

echo "applying Logs"
innobackupex --ibbackup=xtrabackup_55 --parallel=4 --user=$mysql_user --password=$mysql_pass --apply-log $active_backup 2>> $logfile_c

echo "Saving collapsed backup..."

mkdir -p $backup_directory/$backup_filename
mv $active_backup/* $backup_directory/$backup_filename

tar -cvzf $mysql_collapse_path/$backup_filename.tgz $backup_directory/$backup_filename
rm -rf $backup_directory/$backup_filename/*
rmdir $backup_directory/$backup_filename

#delete all log files to start with fresh bin and mysql logs
rm -R $mysql_log_path/*
mkdir $mysql_log_path/bin


 if [ -d $active_backup ];
 then
  rm -R $active_backup/*
  rmdir $active_backup
 fi

echo "Collapse Completed OK!"
}

#-#-#
#-#-#
#-#-#
runamok@nyx:~/Code/surrogate/lib*wip$ 
