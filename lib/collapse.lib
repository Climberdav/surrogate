#!/bin/bash

export PATH=$PATH:/usr/local/mysql/bin

echo "========================================="
echo "           MySQL "
echo "========================================="

if [ $# -ne 1 ];
then
 echo "ERROR: missing parameter. Needs a filename that contains a list of backups to restore...."
exit 1
fi

full_backup=`head $1 -n 1`

active_backup="/data/backups/active_restore"
active_incremental="/data/backups/active_incremental"

logfile="/var/log/db-backup/collapse_"`date +%Y-%m-%d_%H-%M-%S`

mysql_user="sbiadmin"
mysql_pass="t1m3t0J@M"
mysql_data_path="/data/mysql"
mysql_log_path="/data/log"
mysql_collapse_path="/data/backups/collapsed"
backup_filename="compressed_`date +%Y-%m-%d_%H-%M-%S`"

if [ -d $active_backup ];
then
 rm -R $active_backup
fi

echo "copying full backup files: " $full_backup
mkdir $active_backup
cp -r $full_backup/* $active_backup

echo "preparing full backup..."
innobackupex --ibbackup=xtrabackup_55 --parallel=4 --user=$mysql_user --password=$mysql_pass --apply-log --redo-only $active_backup 2> $logfile

# see if the apply-log completed sucsessfully
if ! tail $logfile -n 1 | grep completed.OK
then
        echo "\nERROR: restore failed!"
	rm -R $active_backup
        exit 1
fi


grep _in $1 | while read incremental_backup ; do

 if [ -d $active_incremental ];
 then
  rm -R $active_incremental
 fi

 echo "copying incremental backup: " $incremental_backup
 mkdir $active_incremental
 cp -r $incremental_backup/* $active_incremental

# echo "decompressing ibdata files"
#
# # create an array of .qp files
# qparray=( `find $active_incremental -name '*.qp'` )
#
# # decompress each archive
# for qzip in "${qparray[@]}"
# do
#        :
#        qpress -d $i `dirname $i`/
#        rm $i
# done

 find $incremental_backup -name .delta -empty -maxdepth 2 -exec rm {} \;

        echo "preparing incremetal backup..."
 innobackupex --ibbackup=xtrabackup_55 --parallel=4 --user=$mysql_user --password=$mysql_pass --apply-log --redo-only $active_backup --incremental-dir=$active_incremental 2>> $logfile

 rm -R $active_incremental

 # see if the apply incremental completed sucsessfully
 if ! tail $logfile -n 1 | grep completed.OK
 then
         echo "\nERROR: collapse failed!"
         rm -R $active_backup
         exit 1
 fi

done

echo "applying Logs"
innobackupex --ibbackup=xtrabackup_55 --parallel=4 --user=$mysql_user --password=$mysql_pass --apply-log $active_backup 2>> $logfile

echo "Saving collapsed backup..."

mkdir -p $backup_filename
mv $active_backup/* $backup_filename

tar -cvzf $backup_filename.tgz $backup_filename
rm $backup_filename

#delete all log files to start with fresh bin and mysql logs
rm -R $mysql_log_path/*
mkdir $mysql_log_path/bin

rm -R $active_backup/*
rmdir $active_backup

echo "Collapse Completed OK!"
